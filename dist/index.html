<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reittihaku</title>
  </head>
  <body>
    <p>Reittihaku</p>
    <div id="errorContainer" style="display: none;">
      <p>Error loading data, please refresh page</p>
    </div>
    <label for="from">Mist&auml;:</label>
    <select id="from"> </select>
    <label for="to">Mihin:</label>
    <select id="to"> </select>
    <button id="searchButton">Hae</button>
    <div id='resultContainer'>
      <p id='resultLabel'></p>
    </div>
    <div id='routeTableContainer'></div>
  </body>
  <script>
    window.onload = function () {
      /* sidotaan elementit */
      const selectFrom = document.getElementById('from')
      const selectTo = document.getElementById('to')
      const errorContainer = document.getElementById('errorContainer')
      const searchButton = document.getElementById('searchButton')
      const resultLabel = document.getElementById('resultLabel')
      const routeTableContainer = document.getElementById('routeTableContainer')

      /* minimaalinen virheviesti */
      function displayError() {
        errorContainer.style.display = ''
        errorContainer.style.color = 'red'
      }

      /* luodaan taulukko ihmeteltäväksi */
      function createRouteTable(routes) {
        const table = document.createElement('table')
        const headerRow = document.createElement('tr')
        const tableHeaderCell1 = document.createElement('th')
        tableHeaderCell1.appendChild(document.createTextNode('Pysäkki'))
        const tableHeaderCell2 = document.createElement('th')
        tableHeaderCell2.appendChild(document.createTextNode('Pysäkki'))
        const tableHeaderCell3 = document.createElement('th')
        tableHeaderCell3.appendChild(document.createTextNode('Etäisyys'))
        headerRow.appendChild(tableHeaderCell1)
        headerRow.appendChild(tableHeaderCell2)
        headerRow.appendChild(tableHeaderCell3)
        table.appendChild(headerRow)
        for (const route of routes) {
          const newRow = document.createElement('tr')
          const newCell1 = document.createElement('td')
          newCell1.appendChild(document.createTextNode(route.mista))
          const newCell2 = document.createElement('td')
          newCell2.appendChild(document.createTextNode(route.mihin))
          const newCell3 = document.createElement('td')
          newCell3.appendChild(document.createTextNode(route.kesto))
          newRow.appendChild(newCell1)
          newRow.appendChild(newCell2)
          newRow.appendChild(newCell3)
          table.appendChild(newRow)
        }
        routeTableContainer.appendChild(table)
      }

      /* latailee pysäkit */
      fetch('/api/stops')
        .then((res) => res.json())
        .then((jsonRes) => {
          jsonRes.pysakit.forEach((stop) => {
            const optionFrom = document.createElement('option')
            const optionTo = document.createElement('option')
            optionFrom.setAttribute('value', stop)
            optionTo.setAttribute('value', stop)
            optionFrom.appendChild(document.createTextNode(stop))
            optionTo.appendChild(document.createTextNode(stop))
            selectFrom.appendChild(optionFrom)
            selectTo.appendChild(optionTo)
          })
          createRouteTable(jsonRes.tiet)
        })
        .catch((err) => displayError())

      /* käsittele tulos */
      function parseResult(res) {
        const displayString = `Lyhin etäisyys ${res.lyhinReitti}. Reitti: ${res.reitti.join(' -> ')}`
        resultLabel.innerText = displayString
      }

      /* hae reitti */
      searchButton.onclick = function () {
        resultLabel.innerText = ''
        const from = selectFrom[selectFrom.selectedIndex].value
        const to = selectTo[selectTo.selectedIndex].value
        fetch(`/api/search?from=${from}&to=${to}`)
          .then((res) => res.json())
          .then((jsonRes) => {
            parseResult(jsonRes)
          })
          .catch((err) => displayError())
      }
    }
  </script>
</html>
